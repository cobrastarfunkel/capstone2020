package tables;

import java.io.File;
import java.io.IOException;
import java.security.InvalidKeyException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.SQLException;

import javax.crypto.BadPaddingException;
import javax.crypto.IllegalBlockSizeException;

import database.AppSchemas.MalwareTableSchema;
import database.DatabaseHelper;
import database.SqliteDatabase;
import scenarios.ScenarioHelper;

public class MalwareTable {

	private DatabaseHelper dbh;
	private ScenarioHelper sch;

	public MalwareTable(SqliteDatabase db) {
		this.dbh = new DatabaseHelper(db);
		this.sch = new ScenarioHelper();
		createMalwareTable();
	}

	/**
	 * Create a scenarios Table, Stores files for future use
	 */
	private void createMalwareTable() {
		// SQL to create the Table if it doesn't exist
		String sql = String.format("CREATE TABLE IF NOT EXISTS %s (%s INTEGER, %s BLOB, UNIQUE(%s));",
				MalwareTableSchema.NAME, MalwareTableSchema.Cols.idNumber, MalwareTableSchema.Cols.dMalware,
				MalwareTableSchema.Cols.idNumber);

		dbh.createTable(sql);
		insertMalwareIntoTable();
	}

	/**
	 * Insert Scenarios into the Database
	 * 
	 * @param sc Scenario: The Scenario to add
	 */
	private void insertMalwareIntoTable() {

		// Loop through loaded Scenarios
		for (Integer id : this.dbh.getScenarios().keySet()) {

			String sql = String.format("INSERT OR IGNORE INTO %s (%s,%s) VALUES (?,?)", MalwareTableSchema.NAME,
					MalwareTableSchema.Cols.idNumber, MalwareTableSchema.Cols.dMalware);

			// Connect to the DB and use a prepared statement to insert Scenario into Table
			try (Connection conn = this.dbh.getDb().connect(); PreparedStatement pst = conn.prepareStatement(sql)) {

				// filename column
				pst.setInt(1, this.dbh.getScenarios().get(id).getId());

				// TODO: convert to byte array, store in DB
				File scenarioFile = sch.getScenarioFile(this.dbh.getScenarios().get(id).getDeploy_file());

				this.dbh.getDb().getSecretKey().encryptFile(scenarioFile);

				// content column
				pst.setBytes(2, sch.convertFileToBytes(scenarioFile.toPath()));
				pst.executeUpdate();

				// ######## REMOVE: Unencrypt's the Scenario so we don't have to compile it
				// ######## again for testing REMOVE before completing
				this.dbh.getDb().getSecretKey().decryptFile(scenarioFile);

				// Commit because auto commit is disabled by the connection method in
				// SqliteDatabse
				conn.commit();

			} catch (SQLException e) {
				e.printStackTrace();
			} catch (IOException e) {
				e.printStackTrace();
			} catch (InvalidKeyException e) {
				e.printStackTrace();
			} catch (IllegalBlockSizeException e) {
				e.printStackTrace();
			} catch (BadPaddingException e) {
				e.printStackTrace();
			}
		}
	}
}
